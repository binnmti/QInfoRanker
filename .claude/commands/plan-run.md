---
description: プランのタスクを順次実行し、結果を記録する
---

# プラン実行

指定されたプランフォルダ内のタスクを順次実行し、結果をフィードバックとして記録します。

## 重要原則: ノンストップ実行

**plan-run はユーザーに質問せず、全タスクを自走式で完了まで実行する。**

- 疑問や不明点は `/plan-new` の段階で解決しておくこと
- plan-run 開始後は確認なしで全タスクを順次実行
- 失敗/ブロック時のみユーザーに報告して指示を待つ

## 使い方

```
/plan-run doc/plans/feature-2025-01-improvements
```

引数なしで実行した場合は、`doc/plans/` 内の最新プランを自動選択します。

## 実行手順

### Step 1: プランの読み込みとステータス表示

1. 指定されたプランフォルダの `README.md` を読み込む
2. タスク一覧と依存関係を把握する
3. 各タスクファイル（`task-*.md`）の `## 実行結果` セクションを確認
4. **現在のステータスを表示**:

```
## プラン状況: {プラン名}

| # | タスク名 | ステータス |
|---|---------|-----------|
| 01 | xxx | completed |
| 02 | yyy | completed |
| 03 | zzz | pending ← 次はここから |
| 04 | aaa | pending |

進捗: 2 / 4 (50%)
```

5. **確認なしで即座に実行を開始する**

### Step 2: 未完了タスクの特定

各タスクファイルの `## 実行結果` セクションを確認し、以下を判定：
- `## 実行結果` がない、または `ステータス: pending` → 未実行
- `ステータス: completed` → 完了済み
- `ステータス: blocked` → ブロック中（依存タスクの完了待ち）

依存関係を考慮し、実行可能な最初の未完了タスクを選択する。

### Step 3: タスクの実行（サブエージェント使用）

**重要**: 各タスクは `Task` ツールでサブエージェントを起動して実行すること。

```
Task ツールを使用:
- subagent_type: general-purpose
- prompt: 以下のタスクを実行してください。

  ## タスクファイル
  {タスクファイルの内容}

  ## 開発原則
  CLAUDE.mdの開発原則に従ってください。

  ## 完了条件
  - 実装内容のチェックリストを全て完了
  - `dotnet build` が成功
  - `dotnet test` が成功（テストがある場合）

  ## 報告形式
  完了後、以下の形式で報告してください：
  - ステータス: completed / blocked / failed
  - 変更ファイル: 変更したファイルのリスト
  - 学んだこと: 実装中に気づいた点（あれば）
  - 問題点: 発生した問題と解決方法（あれば）
```

### Step 4: コードレビューと修正

タスク実行後、`/local-review` 相当のレビューを実施：

1. **変更内容の確認**: `git diff` で変更を把握
2. **CodeRabbit レビュー**（利用可能な場合）:
   ```bash
   wsl bash -c "~/.local/bin/cr review --plain -t uncommitted --cwd /mnt/e/Code/Private/QInfoRanker"
   ```
3. **セルフレビュー**: 以下の観点でチェック
   - バグ・論理エラーの可能性
   - セキュリティリスク
   - CLAUDE.md の開発原則との整合性
   - 命名・可読性

4. **指摘事項の修正**: 「重大」「推奨」の指摘を修正
5. **再レビュー**: 修正後、指摘が解消されるまで繰り返し

### Step 5: コミット

レビュー完了後、変更をコミット：

```bash
git add .
git commit -m "<type>: <description>

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

### Step 6: 結果の記録

サブエージェントの報告を元に、タスクファイルの末尾に `## 実行結果` セクションを追記：

```markdown
## 実行結果

- **実行日時**: 2025-01-18 15:30
- **ステータス**: completed / blocked / failed
- **変更ファイル**:
  - src/xxx.cs
  - src/yyy.cs
- **レビュー結果**: 指摘N件 → 修正済み
- **コミット**: {コミットハッシュ}
- **学んだこと**:
  - （サブエージェントからの報告）
- **問題点**:
  - （発生した問題と解決方法）
```

### Step 7: RETROSPECTIVE への転記

問題点や学んだことがあれば、`RETROSPECTIVE.md` に追記する：

```markdown
### タスクXX: {タスク名}
- **問題**: （何が起きたか）
- **原因**: （なぜ起きたか）
- **対応**: （どう解決したか）
- **再発防止**: （今後どうすべきか）
```

### Step 8: 次のタスクへ

- 成功した場合: **確認なしで** Step 2 に戻り、次の未完了タスクを実行
- 失敗/ブロックの場合: ユーザーに報告し、指示を待つ

### Step 9: プラン完了

全タスクが完了したら：

1. `README.md` の進捗チェックリストを全て完了にする
2. `RETROSPECTIVE.md` の「良かった点」を記入
3. 重要な学びがあれば `doc/plans/LESSONS_LEARNED.md` への昇格を提案
4. 完了報告をユーザーに行う

## 出力形式

各タスク完了後：

```
## タスク {番号} 完了

- タスク: {タスク名}
- ステータス: completed
- 変更ファイル: N件
- 次のタスク: {次のタスク名} / なし（全完了）
```

プラン完了後：

```
## プラン完了: {プラン名}

- 完了タスク: N / N
- 総変更ファイル: N件
- 問題点: N件（RETROSPECTIVE.md参照）
- 学び: N件（LESSONS_LEARNED.md参照）
```

## 注意事項

- **ノンストップ実行**: ユーザーへの確認なしで全タスクを連続実行する
- **疑問は plan-new で解決**: plan-run 開始後に質問しない
- 各タスクは必ずサブエージェントで実行し、コンテキストを分離する
- タスク完了後は必ず結果をタスクファイルに記録する
- ビルド/テストが失敗した場合は、修正してから完了とする
- 依存関係を無視して先のタスクを実行しない
- 失敗/ブロック時のみユーザーに報告して指示を待つ
