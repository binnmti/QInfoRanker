---
description: プランのタスクを順次実行し、結果を記録する
---

# プラン実行

指定されたプランフォルダ内のタスクを順次実行し、結果をフィードバックとして記録します。

## 重要原則

### ノンストップ実行

**plan-run はユーザーに質問せず、全タスクを自走式で完了まで実行する。**

- 疑問や不明点は `/plan-new` の段階で解決しておくこと
- plan-run 開始後は確認なしで全タスクを順次実行
- 失敗/ブロック時のみユーザーに報告して指示を待つ

### コンテキスト節約

**親コンテキストの膨張を抑えるため、以下を守る：**

- サブエージェントの結果報告は簡潔に受け取る
- タスク完了報告は1-2行で済ませる
- 詳細はタスクファイルに記録し、親では繰り返さない
- 不要な確認メッセージを出力しない

## 使い方

```
/plan-run doc/plans/feature-2025-01-improvements
```

引数なしで実行した場合は、`doc/plans/` 内の最新プランを自動選択します。

## 実行手順

### Step 1: プランの読み込みと実行開始

1. `README.md` を読み込み、タスク一覧を把握
2. 現在のステータスを簡潔に表示（進捗のみ）
3. **確認なしで即座に実行を開始する**

### Step 2: タスクの実行（サブエージェント）

各タスクは `Task` ツール（general-purpose）で実行。以下をサブエージェントに指示：

```
以下のタスクを実行してください。

## タスクファイル
{タスクファイルの内容}

## 開発原則
CLAUDE.mdの開発原則に従ってください。

## 実行後の更新
1. タスクファイルの「## 実装内容」「## テスト」のチェックリストを全て [x] にする
2. タスクファイル冒頭の「## 概要」セクションに、実装内容を1-2文で追記する
   （PRの概要のような簡潔な説明）

## 完了条件
- 実装内容のチェックリストを全て完了
- `dotnet build` が成功
- `dotnet test` が成功（テストがある場合）

## 報告形式（簡潔に）
- ステータス: completed / blocked / failed
- 変更ファイル: リスト
- 学んだこと: 1-2点（あれば）
```

### Step 3: レビュー（/local-review）

サブエージェント完了後、コミット前にレビューを実施：

1. `git diff` で変更内容を確認
2. CodeRabbitレビュー実行（レート制限時はスキップ）
3. GitHub Copilotレビュー実行
4. Claude Codeセルフレビュー実行
5. 「重大」「推奨」の指摘があれば修正
6. 修正後、再レビュー（最大3回）

```bash
# CodeRabbit
wsl bash -c "~/.local/bin/cr review --plain -t uncommitted --cwd /mnt/e/Code/Private/QInfoRanker"

# GitHub Copilot
copilot --model gpt-5.1-codex-max -p "以下のgit diffをコードレビューしてください。バグ、セキュリティリスク、設計上の問題点を「重大」「警告」「軽微」に分類して指摘してください: $(git diff -- . ':(exclude)*.Designer.cs')"
```

**終了条件:**
- 「重大」「推奨」の指摘が0件
- または3回ループした

### Step 4: コミット

レビュー完了後、コミット：

```bash
git add {変更ファイル}
git commit -m "<type>: <description>

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

### Step 5: 結果の記録

タスクファイルの末尾に `## 実行結果` を追記：

```markdown
## 実行結果

- **実行日時**: YYYY-MM-DD
- **ステータス**: completed
- **変更ファイル**:
  - src/xxx.cs
- **コミット**: {ハッシュ}
- **学んだこと**: {あれば}
- **問題点**: なし
```

### Step 6: 次のタスクへ

- 成功: **確認なしで** Step 2 に戻り、次の未完了タスクを実行
- 失敗/ブロック: ユーザーに報告して指示を待つ

### Step 7: プラン完了

全タスク完了後：

1. `README.md` の進捗チェックリストを更新
2. 完了報告（簡潔に）

## 出力形式

**タスク完了時（1-2行）：**
```
## タスク {番号} 完了 → 次: {次のタスク名}
```

**プラン完了時：**
```
## プラン完了: {プラン名}
完了タスク: N / N
```

## 注意事項

- **ノンストップ実行**: 確認なしで全タスクを連続実行
- **疑問は plan-new で解決**: plan-run では質問しない
- **コンテキスト節約**: 詳細はタスクファイルに、親では簡潔に
- **サブエージェントがチェックリストを更新**: 実行後に [x] を付ける
- **サブエージェントが概要を追記**: 冒頭に実装概要を書く
- 依存関係を無視して先のタスクを実行しない
- 失敗/ブロック時のみユーザーに報告
