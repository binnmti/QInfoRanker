@page "/settings"
@attribute [Authorize]
@rendermode InteractiveServer
@using Microsoft.Extensions.Options
@using QInfoRanker.Infrastructure.Scoring
@inject IScoringService ScoringService
@inject IConfiguration Configuration
@inject IOptions<EnsembleScoringOptions> EnsembleOptions

<PageTitle>Settings - QInfoRanker</PageTitle>

<h1>Settings</h1>

<h2>Azure OpenAI Connection Test</h2>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Current Configuration</h5>
        <dl class="row">
            <dt class="col-sm-3">Endpoint</dt>
            <dd class="col-sm-9"><code>@GetMaskedEndpoint()</code></dd>

            <dt class="col-sm-3">Deployment</dt>
            <dd class="col-sm-9"><code>@Configuration["AzureOpenAI:DeploymentName"]</code></dd>

            <dt class="col-sm-3">API Key</dt>
            <dd class="col-sm-9"><code>@GetMaskedApiKey()</code></dd>
        </dl>

        <button class="btn btn-primary" @onclick="TestConnection" disabled="@isTesting">
            @if (isTesting)
            {
                <span class="spinner-border spinner-border-sm" role="status"></span>
                <span>Testing...</span>
            }
            else
            {
                <span>Test Connection</span>
            }
        </button>

        @if (!string.IsNullOrEmpty(testResult))
        {
            <div class="alert @(testSuccess ? "alert-success" : "alert-danger") mt-3">
                <strong>@(testSuccess ? "Success!" : "Error:")</strong>
                <pre class="mb-0 mt-2">@testResult</pre>
            </div>
        }
    </div>
</div>

<h2>アンサンブル評価設定</h2>

<div class="card mb-4">
    <div class="card-body">
        <div class="mb-3">
            <strong>状態:</strong>
            <span class="badge bg-success ms-2">常に有効</span>
            <small class="text-muted ms-2">(アンサンブル評価は常に使用されます)</small>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <h6>基本設定</h6>
                <dl class="row small">
                    <dt class="col-sm-7">最大並列Judge数</dt>
                    <dd class="col-sm-5">@EnsembleOptions.Value.MaxParallelJudges</dd>

                    <dt class="col-sm-7">Judgeタイムアウト</dt>
                    <dd class="col-sm-5">@(EnsembleOptions.Value.JudgeTimeoutMs / 1000)秒</dd>
                </dl>
            </div>
            <div class="col-md-6">
                <h6>Meta-Judge</h6>
                <dl class="row small">
                    <dt class="col-sm-7">状態</dt>
                    <dd class="col-sm-5">
                        @if (EnsembleOptions.Value.MetaJudge.IsEnabled)
                        {
                            <span class="badge bg-success">有効</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">無効</span>
                        }
                    </dd>

                    <dt class="col-sm-7">モデル</dt>
                    <dd class="col-sm-5"><code>@EnsembleOptions.Value.MetaJudge.DeploymentName</code></dd>

                    <dt class="col-sm-7">最大トークン</dt>
                    <dd class="col-sm-5">@EnsembleOptions.Value.MetaJudge.MaxTokens</dd>

                    <dt class="col-sm-7">矛盾検出閾値</dt>
                    <dd class="col-sm-5">@EnsembleOptions.Value.MetaJudge.ContradictionThreshold</dd>
                </dl>
            </div>
        </div>

        <h6>Judge構成</h6>
        @if (EnsembleOptions.Value.Judges.Any())
        {
            <table class="table table-sm table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>表示名</th>
                        <th>モデル</th>
                        <th>重み</th>
                        <th>専門</th>
                        <th>状態</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var judge in EnsembleOptions.Value.Judges)
                    {
                        <tr class="@(judge.IsEnabled ? "" : "text-muted")">
                            <td>@judge.JudgeId</td>
                            <td>@judge.EffectiveDisplayName</td>
                            <td><code>@judge.DeploymentName</code></td>
                            <td>@judge.Weight</td>
                            <td>@(judge.Specialty ?? "汎用")</td>
                            <td>
                                @if (judge.IsEnabled)
                                {
                                    <span class="badge bg-success">有効</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">無効</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
        else
        {
            <div class="alert alert-info">Judgeが設定されていません。</div>
        }

        <div class="alert alert-info mt-3 small">
            <strong>設定変更方法:</strong>
            <code>appsettings.json</code> の <code>EnsembleScoring</code> セクションを編集してください。
            アプリケーションの再起動が必要です。
        </div>
    </div>
</div>

@code {
    private bool isTesting = false;
    private string testResult = string.Empty;
    private bool testSuccess = false;

    private string GetMaskedEndpoint()
    {
        var endpoint = Configuration["AzureOpenAI:Endpoint"];
        return string.IsNullOrEmpty(endpoint) ? "(not configured)" : endpoint;
    }

    private string GetMaskedApiKey()
    {
        var apiKey = Configuration["AzureOpenAI:ApiKey"];
        if (string.IsNullOrEmpty(apiKey))
            return "(not configured)";
        if (apiKey.Length <= 8)
            return "****";
        return apiKey[..4] + "..." + apiKey[^4..];
    }

    private async Task TestConnection()
    {
        isTesting = true;
        testResult = string.Empty;
        StateHasChanged();

        try
        {
            // Create a test article
            var testArticle = new Article
            {
                Title = "Test Article: Quantum Computing Breakthrough",
                Summary = "Scientists achieve new milestone in quantum error correction.",
                Url = "https://example.com/test"
            };

            // Try to score it
            var result = await ScoringService.CalculateLlmScoreAsync(testArticle, false);

            if (result.LlmScore.HasValue)
            {
                testSuccess = true;
                testResult = $"Connection successful!\n\n" +
                            $"Test article scored:\n" +
                            $"  Technical: {result.TechnicalScore}\n" +
                            $"  Novelty: {result.NoveltyScore}\n" +
                            $"  Impact: {result.ImpactScore}\n" +
                            $"  Quality: {result.QualityScore}\n" +
                            $"  Total: {result.LlmScore}";
            }
            else
            {
                testSuccess = false;
                testResult = "No score returned. Check if Azure OpenAI is properly configured.";
            }
        }
        catch (Exception ex)
        {
            testSuccess = false;
            testResult = $"{ex.GetType().Name}: {ex.Message}";
        }
        finally
        {
            isTesting = false;
        }
    }
}
