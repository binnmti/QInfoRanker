@page "/top10"
@page "/weekly-summary"
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@using QInfoRanker.Core.Entities
@using QInfoRanker.Core.Enums
@using Markdig
@inject IArticleService ArticleService
@inject IKeywordService KeywordService
@inject IWeeklySummaryService SummaryService

<PageTitle>ä»Šé€±ã®ãŠã™ã™ã‚ - QInfoRanker</PageTitle>

<style>
    .category-column {
        min-height: 400px;
    }
    .category-header {
        border-bottom: 3px solid;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .category-news .category-header { border-color: #dc3545; }
    .category-tech .category-header { border-color: #0d6efd; }
    .category-academic .category-header { border-color: #198754; }

    .trend-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 1rem;
    }
    .trend-tag {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 1rem;
        background-color: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
    }

    .article-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }
    .article-item:last-child {
        border-bottom: none;
    }
    .article-item:hover {
        background-color: #f8f9fa;
        margin: 0 -0.5rem;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    .article-title {
        font-size: 0.9rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .article-meta {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .summary-card {
        border-left: 4px solid #0d6efd;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
    }
    .summary-content {
        font-size: 0.9rem;
        line-height: 1.6;
    }
    .summary-content a {
        color: #0d6efd;
        text-decoration: none;
    }
    .summary-content a:hover {
        text-decoration: underline;
    }
    .summary-content h2, .summary-content h3 {
        font-size: 1rem;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
    }
    .summary-content ul, .summary-content ol {
        margin-bottom: 0.5rem;
        padding-left: 1.25rem;
    }
    .summary-content li {
        margin-bottom: 0.25rem;
    }
    .summary-content p {
        margin-bottom: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    </style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">ä»Šé€±ã®ãŠã™ã™ã‚</h1>
    <div class="d-flex align-items-center gap-2">
        <select class="form-select form-select-sm" style="width: auto;" @bind="selectedKeywordId" @bind:after="LoadAll">
            <option value="">ã™ã¹ã¦ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</option>
            @foreach (var keyword in keywords)
            {
                <option value="@keyword.Id">@keyword.Term</option>
            }
        </select>
    </div>
</div>

<p class="text-muted small mb-3">
    @weekStart.ToString("M/d") ã€œ @weekEnd.ToString("M/d") ã®ãŠã™ã™ã‚è¨˜äº‹
</p>

@* çµ±åˆã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ *@
@if (selectedKeywordId.HasValue)
{
    @if (isLoadingSummary)
    {
        <div class="card summary-card mb-4">
            <div class="card-body text-center py-3">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                ã‚µãƒãƒªãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    }
    else if (currentSummary != null)
    {
        <div class="card summary-card mb-4">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">@currentSummary.Title</h5>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="RegenerateSummary" disabled="@isGenerating" title="ã‚µãƒãƒªãƒ¼ã‚’å†ç”Ÿæˆ">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                        }
                        else
                        {
                            <span>ğŸ”„</span>
                        }
                    </button>
                </div>
                <div class="summary-content">
                    @((MarkupString)RenderMarkdown(currentSummary.Content))
                </div>
                <div class="mt-2 small text-muted">
                    @currentSummary.ArticleCount ä»¶ã®è¨˜äº‹ã‚’å‚ç…§ | ç”Ÿæˆ: @currentSummary.GeneratedAt.ToLocalTime().ToString("M/d HH:mm")
                </div>
                @if (!string.IsNullOrEmpty(generateError))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-2 small">@generateError</div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card summary-card mb-4">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">
                        ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é€±é–“ã‚µãƒãƒªãƒ¼ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
                    </span>
                    <button class="btn btn-sm btn-outline-primary" @onclick="GenerateSummary" disabled="@isGenerating">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>ç”Ÿæˆä¸­...</span>
                        }
                        else
                        {
                            <span>ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ</span>
                        }
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(generateError))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-2 small">@generateError</div>
                }
            </div>
        </div>
    }
}

@* 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ *@
@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        @* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ©ãƒ  *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-news">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">ğŸ“°</span>
                    <h5 class="mb-0">ãƒ‹ãƒ¥ãƒ¼ã‚¹</h5>
                    <small class="text-muted ms-auto">@newsArticles.Count()ä»¶</small>
                </div>

                @if (newsTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in newsTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                @if (!newsArticles.Any())
                {
                    <div class="empty-state">
                        <p class="mb-0">ãŠã™ã™ã‚è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                }
                else
                {
                    foreach (var article in newsArticles)
                    {
                        <div class="article-item" @key="article.Id">
                            <div class="d-flex gap-2">
                                <span style="font-size: 1rem;">ğŸ”¥</span>
                                <div class="flex-grow-1">
                                    <a href="@article.Url" target="_blank"
                                       class="article-title text-decoration-none d-block"
                                       title="@GetTooltipText(article)">
                                        @article.Title
                                    </a>
                                    <div class="article-meta d-flex gap-2 mt-1">
                                        <span>@article.Source.Name</span>
                                        @if (article.PublishedAt.HasValue)
                                        {
                                            <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        @* æŠ€è¡“è¨˜äº‹ã‚«ãƒ©ãƒ  *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-tech">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">ğŸ’»</span>
                    <h5 class="mb-0">æŠ€è¡“è¨˜äº‹</h5>
                    <small class="text-muted ms-auto">@techArticles.Count()ä»¶</small>
                </div>

                @if (techTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in techTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                @if (!techArticles.Any())
                {
                    <div class="empty-state">
                        <p class="mb-0">ãŠã™ã™ã‚è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                }
                else
                {
                    foreach (var article in techArticles)
                    {
                        <div class="article-item" @key="article.Id">
                            <div class="d-flex gap-2">
                                <span style="font-size: 1rem;">ğŸ”¥</span>
                                <div class="flex-grow-1">
                                    <a href="@article.Url" target="_blank"
                                       class="article-title text-decoration-none d-block"
                                       title="@GetTooltipText(article)">
                                        @article.Title
                                    </a>
                                    <div class="article-meta d-flex gap-2 mt-1">
                                        <span>@article.Source.Name</span>
                                        <span>@article.CollectedAt.ToString("M/d")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>

        @* ç ”ç©¶ã‚«ãƒ©ãƒ  *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-academic">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">ğŸ“š</span>
                    <h5 class="mb-0">ç ”ç©¶</h5>
                    <small class="text-muted ms-auto">@academicArticles.Count()ä»¶</small>
                </div>

                @if (academicTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in academicTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                @if (!academicArticles.Any())
                {
                    <div class="empty-state">
                        <p class="mb-0">ãŠã™ã™ã‚è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                }
                else
                {
                    foreach (var article in academicArticles)
                    {
                        <div class="article-item" @key="article.Id">
                            <div class="d-flex gap-2">
                                <span style="font-size: 1rem;">ğŸ”¥</span>
                                <div class="flex-grow-1">
                                    <a href="@article.Url" target="_blank"
                                       class="article-title text-decoration-none d-block"
                                       title="@GetTooltipText(article)">
                                        @article.Title
                                    </a>
                                    <div class="article-meta d-flex gap-2 mt-1">
                                        <span>@article.Source.Name</span>
                                        <span>@article.CollectedAt.ToString("M/d")</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
}

@code {
    private List<Keyword> keywords = new();
    private int? selectedKeywordId;
    private bool isLoading = true;
    private DateTime weekStart;
    private DateTime weekEnd;

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥è¨˜äº‹
    private IEnumerable<Article> newsArticles = Enumerable.Empty<Article>();
    private IEnumerable<Article> techArticles = Enumerable.Empty<Article>();
    private IEnumerable<Article> academicArticles = Enumerable.Empty<Article>();

    // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚°ï¼ˆå¾Œã§å®Ÿè£…ï¼‰
    private List<string> newsTrendTags = new();
    private List<string> techTrendTags = new();
    private List<string> academicTrendTags = new();

    // ã‚µãƒãƒªãƒ¼é–¢é€£
    private Core.Entities.WeeklySummary? currentSummary;
    private bool isLoadingSummary = false;
    private bool isGenerating = false;
    private string? generateError;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseAutoLinks()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        CalculateWeekRange();
        keywords = (await KeywordService.GetActiveAsync()).ToList();
        await LoadAll();
    }

    private void CalculateWeekRange()
    {
        var today = DateTime.UtcNow.Date;
        var diff = (7 + (today.DayOfWeek - DayOfWeek.Monday)) % 7;
        weekStart = today.AddDays(-diff);
        weekEnd = weekStart.AddDays(6);
    }

    private async Task LoadAll()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // DbContext ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªã„ãŸã‚é †æ¬¡å®Ÿè¡Œ
            await LoadCategoryArticles();
            await LoadSummary();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private const int RecommendThreshold = 17;  // ãŠã™ã™ã‚è¡¨ç¤ºã®é–¾å€¤ï¼ˆ0-20ï¼‰

    private async Task LoadCategoryArticles()
    {
        // DbContext ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªã„ãŸã‚é †æ¬¡å®Ÿè¡Œ
        newsArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.News, RecommendThreshold, selectedKeywordId, 10);
        techArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.Technology, RecommendThreshold, selectedKeywordId, 10);
        academicArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.Academic, RecommendThreshold, selectedKeywordId, 10);

        // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚°ã‚’æŠ½å‡ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼šã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é »å‡ºå˜èªã‚’æŠ½å‡ºï¼‰
        newsTrendTags = ExtractSimpleTrendTags(newsArticles);
        techTrendTags = ExtractSimpleTrendTags(techArticles);
        academicTrendTags = ExtractSimpleTrendTags(academicArticles);
    }

    private List<string> ExtractSimpleTrendTags(IEnumerable<Article> articles)
    {
        if (!articles.Any()) return new List<string>();

        // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å˜èªã‚’æŠ½å‡ºã—ã€é »å‡ºä¸Šä½ã‚’è¿”ã™ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        var words = articles
            .SelectMany(a => ExtractKeywords(a.Title))
            .GroupBy(w => w)
            .OrderByDescending(g => g.Count())
            .Take(3)
            .Select(g => g.Key)
            .ToList();

        return words;
    }

    private IEnumerable<string> ExtractKeywords(string title)
    {
        // ç°¡æ˜“çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆè‹±å˜èªã¨æ—¥æœ¬èªã®ä¸€éƒ¨ã‚’æŠ½å‡ºï¼‰
        var words = new List<string>();

        // è‹±å˜èªï¼ˆ3æ–‡å­—ä»¥ä¸Šï¼‰
        var englishPattern = new System.Text.RegularExpressions.Regex(@"\b[A-Za-z]{3,}\b");
        var matches = englishPattern.Matches(title);
        foreach (System.Text.RegularExpressions.Match match in matches)
        {
            var word = match.Value;
            // ä¸€èˆ¬çš„ãªå˜èªã¯é™¤å¤–
            if (!IsCommonWord(word))
            {
                words.Add(word);
            }
        }

        return words;
    }

    private bool IsCommonWord(string word)
    {
        var commonWords = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "the", "and", "for", "with", "from", "that", "this", "are", "was", "were",
            "have", "has", "had", "been", "being", "will", "would", "could", "should",
            "can", "may", "might", "must", "shall", "into", "about", "over", "after",
            "before", "under", "between", "through", "during", "without", "within",
            "new", "how", "why", "what", "when", "where", "which", "who", "whom",
            "using", "use", "used", "based", "make", "made", "get", "got", "set"
        };
        return commonWords.Contains(word);
    }

    private async Task LoadSummary()
    {
        if (!selectedKeywordId.HasValue)
        {
            currentSummary = null;
            return;
        }

        isLoadingSummary = true;
        generateError = null;

        try
        {
            currentSummary = await SummaryService.GetCurrentWeekSummaryAsync(selectedKeywordId.Value);
        }
        finally
        {
            isLoadingSummary = false;
        }
    }

    private async Task GenerateSummary()
    {
        if (!selectedKeywordId.HasValue) return;

        isGenerating = true;
        generateError = null;
        StateHasChanged();

        try
        {
            currentSummary = await SummaryService.GenerateSummaryAsync(selectedKeywordId.Value);
        }
        catch (Exception ex)
        {
            generateError = $"ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task RegenerateSummary()
    {
        // æ—¢å­˜ã‚µãƒãƒªãƒ¼ãŒã‚ã£ã¦ã‚‚å†ç”Ÿæˆ
        await GenerateSummary();
    }

    private static string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown)) return string.Empty;
        var html = Markdown.ToHtml(markdown, _markdownPipeline);
        html = html.Replace("<a href=", "<a target=\"_blank\" rel=\"noopener noreferrer\" href=");
        return html;
    }

    private static string? GetTooltipText(Article article)
    {
        // æ—¥æœ¬èªè¦ç´„ãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°null
        if (!string.IsNullOrEmpty(article.SummaryJa))
        {
            // é•·ã™ãã‚‹å ´åˆã¯åˆ‡ã‚Šè©°ã‚ã‚‹
            var text = article.SummaryJa;
            if (text.Length > 150)
            {
                text = text[..150] + "...";
            }
            return text;
        }
        return null;
    }
}
