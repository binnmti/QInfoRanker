@page "/"
@page "/weekly"
@page "/weekly/{KeywordParam?}"
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@using QInfoRanker.Core.Entities
@using QInfoRanker.Core.Enums
@using QInfoRanker.Core.Interfaces.Services
@using Markdig
@inject IArticleService ArticleService
@inject IKeywordService KeywordService
@inject IWeeklySummaryService SummaryService
@inject NavigationManager NavigationManager

<PageTitle>‰ªäÈÄ±„ÅÆ„Åä„Åô„Åô„ÇÅ - QInfoRanker</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">‰ªäÈÄ±„ÅÆ„Åä„Åô„Åô„ÇÅ</h1>
    <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group">
            @foreach (var keyword in keywords)
            {
                <a href="/weekly/@keyword.GetUrlIdentifier()"
                   class="btn btn-sm @(selectedKeywordId == keyword.Id ? "btn-primary" : "btn-outline-primary")">
                    @keyword.Term
                </a>
            }
        </div>
    </div>
</div>

<p class="text-muted small mb-3">
    @weekStart.ToString("M/d") „Äú @weekEnd.ToString("M/d") „ÅÆ„Åä„Åô„Åô„ÇÅË®ò‰∫ã
</p>

@* Áµ±Âêà„Çµ„Éû„É™„Éº„Çª„ÇØ„Ç∑„Éß„É≥ *@
@if (selectedKeywordId.HasValue)
{
    @if (isLoadingSummary)
    {
        <div class="card summary-card mb-4">
            <div class="card-body text-center py-3">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                „Çµ„Éû„É™„Éº„ÇíË™≠„ÅøËæº„Åø‰∏≠...
            </div>
        </div>
    }
    else if (currentSummary != null)
    {
        <div class="card summary-card mb-4">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">@currentSummary.Title</h5>
                    <div class="d-flex align-items-center gap-2">
                        @* Â±•Ê≠¥„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ *@
                        <div class="history-nav">
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="GoToPreviousSummary"
                                    disabled="@(!hasPreviousSummary || isNavigating)"
                                    title="Ââç„ÅÆË¶ÅÁ¥ÑÔºàÂè§„ÅÑÊñπÂêëÔºâ">
                                ‚Üê
                            </button>
                            @if (isLatestSummary)
                            {
                                <span class="history-badge latest">ÊúÄÊñ∞</span>
                            }
                            else
                            {
                                <span class="history-badge">Â±•Ê≠¥</span>
                            }
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="GoToNextSummary"
                                    disabled="@(!hasNextSummary || isNavigating)"
                                    title="Ê¨°„ÅÆË¶ÅÁ¥ÑÔºàÊñ∞„Åó„ÅÑÊñπÂêëÔºâ">
                                ‚Üí
                            </button>
                        </div>
                        <AuthorizeView>
                            <Authorized>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="RegenerateSummary" disabled="@isGenerating" title="„Çµ„Éû„É™„Éº„ÇíÂÜçÁîüÊàê">
                                    @if (isGenerating)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    }
                                    else
                                    {
                                        <span>+</span>
                                    }
                                </button>
                            </Authorized>
                        </AuthorizeView>
                    </div>
                </div>
                @* ÁîªÂÉèË°®Á§∫„ÅØ‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ
                @if (!string.IsNullOrEmpty(currentSummary.ImageUrl))
                {
                    <div class="summary-image mb-3">
                        <img src="@currentSummary.ImageUrl"
                             alt="@currentSummary.Title"
                             class="img-fluid rounded"
                             style="max-height: 300px; width: 100%; object-fit: cover;" />
                    </div>
                }
                *@
                <div class="summary-content">
                    @((MarkupString)RenderMarkdown(currentSummary.Content))
                </div>
                <div class="mt-2 small text-muted d-flex justify-content-between align-items-center">
                    <span>@currentSummary.ArticleCount ‰ª∂„ÅÆË®ò‰∫ã„ÇíÂèÇÁÖß</span>
                    <span>
                        @currentSummary.WeekStart.ToString("M/d")„Äú@currentSummary.WeekEnd.ToString("M/d") |
                        ÁîüÊàê: @currentSummary.GeneratedAt.ToLocalTime().ToString("M/d HH:mm")
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(generateError))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-2 small">@generateError</div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card summary-card mb-4">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">
                        „Åì„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÈÄ±Èñì„Çµ„Éû„É™„Éº„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì
                    </span>
                    <button class="btn btn-sm btn-outline-primary" @onclick="GenerateSummary" disabled="@(isGenerating || (diagnostics != null && !diagnostics.CanGenerateSummary))">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>ÁîüÊàê‰∏≠...</span>
                        }
                        else
                        {
                            <span>„Çµ„Éû„É™„Éº„ÇíÁîüÊàê</span>
                        }
                    </button>
                </div>
                @if (diagnostics != null)
                {
                    <div class="mt-3 small">
                        <div class="d-flex flex-wrap gap-3 text-muted mb-2">
                            <span title="Azure OpenAIË®≠ÂÆöÁä∂ÊÖã">
                                @if (diagnostics.IsAzureOpenAIConfigured)
                                {
                                    <span class="text-success">AI: Ë®≠ÂÆöÊ∏à„Åø (@diagnostics.DeploymentName)</span>
                                }
                                else
                                {
                                    <span class="text-danger">AI: Êú™Ë®≠ÂÆö</span>
                                }
                            </span>
                            <span title="„Çπ„Ç≥„Ç¢„É™„É≥„Ç∞Ê∏à„ÅøË®ò‰∫ãÊï∞">
                                Ë®ò‰∫ã: @(diagnostics.TotalArticleCount)‰ª∂
                                („Éã„É•„Éº„Çπ @(diagnostics.NewsArticleCount) / ÊäÄË°ì @(diagnostics.TechArticleCount) / Á†îÁ©∂ @(diagnostics.AcademicArticleCount))
                            </span>
                            <span title="ÂøÖË¶Å„Å™ÊúÄ‰ΩéË®ò‰∫ãÊï∞">
                                ÂøÖË¶Å: @(diagnostics.MinRequiredArticles)‰ª∂‰ª•‰∏ä
                            </span>
                        </div>
                        @if (!diagnostics.CanGenerateSummary && !string.IsNullOrEmpty(diagnostics.BlockingReason))
                        {
                            <div class="alert alert-warning py-2 mb-0">
                                <strong>ÁîüÊàê„Åß„Åç„Å™„ÅÑÁêÜÁî±:</strong> @diagnostics.BlockingReason
                            </div>
                        }
                    </div>
                }
                @if (!string.IsNullOrEmpty(generateError))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-2 small">@generateError</div>
                }
            </div>
        </div>
    }
}

@* 3„Ç´„É©„É†„É¨„Ç§„Ç¢„Ç¶„Éà *@
@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        @* „Éã„É•„Éº„Çπ„Ç´„É©„É† *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-news">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">üì∞</span>
                    <h5 class="mb-0">„Éã„É•„Éº„Çπ</h5>
                </div>

                @if (newsTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in newsTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                <div class="category-articles">
                    @if (!newsArticles.Any())
                    {
                        <div class="empty-state">
                            <p class="mb-0">„Åä„Åô„Åô„ÇÅË®ò‰∫ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    }
                    else
                    {
                        foreach (var article in newsArticles)
                        {
                            <div class="article-item" @key="article.Id">
                                <div class="d-flex gap-2">
                                    <span style="font-size: 1rem;">üî•</span>
                                    <div class="flex-grow-1">
                                        <a href="@article.Url" target="_blank"
                                           class="article-title text-decoration-none d-block"
                                           title="@GetTooltipText(article)">
                                            @article.Title
                                        </a>
                                        <div class="article-meta d-flex gap-2 mt-1">
                                            <span>@article.Source.Name</span>
                                            @if (article.PublishedAt.HasValue)
                                            {
                                                <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @if (newsArticles.Count < newsTotalCount)
                    {
                        <div class="load-more-btn">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadMoreNews" disabled="@isLoadingMoreNews">
                                @if (isLoadingMoreNews)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                @{
                                    var newsRemaining = newsTotalCount - newsArticles.Count;
                                    var newsLoadCount = Math.Min(newsRemaining, PageSize);
                                }
                                „ÇÇ„Å£„Å®Ë¶ã„ÇãÔºàÊ¨°„ÅÆ @newsLoadCount ‰ª∂Ôºâ
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* ÊäÄË°ìË®ò‰∫ã„Ç´„É©„É† *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-tech">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">üíª</span>
                    <h5 class="mb-0">ÊäÄË°ìË®ò‰∫ã</h5>
                </div>

                @if (techTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in techTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                <div class="category-articles">
                    @if (!techArticles.Any())
                    {
                        <div class="empty-state">
                            <p class="mb-0">„Åä„Åô„Åô„ÇÅË®ò‰∫ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    }
                    else
                    {
                        foreach (var article in techArticles)
                        {
                            <div class="article-item" @key="article.Id">
                                <div class="d-flex gap-2">
                                    <span style="font-size: 1rem;">üî•</span>
                                    <div class="flex-grow-1">
                                        <a href="@article.Url" target="_blank"
                                           class="article-title text-decoration-none d-block"
                                           title="@GetTooltipText(article)">
                                            @article.Title
                                        </a>
                                        <div class="article-meta d-flex gap-2 mt-1">
                                            <span>@article.Source.Name</span>
                                            @if (article.PublishedAt.HasValue)
                                            {
                                                <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @if (techArticles.Count < techTotalCount)
                    {
                        <div class="load-more-btn">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadMoreTech" disabled="@isLoadingMoreTech">
                                @if (isLoadingMoreTech)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                @{
                                    var techRemaining = techTotalCount - techArticles.Count;
                                    var techLoadCount = Math.Min(techRemaining, PageSize);
                                }
                                „ÇÇ„Å£„Å®Ë¶ã„ÇãÔºàÊ¨°„ÅÆ @techLoadCount ‰ª∂Ôºâ
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* Á†îÁ©∂„Ç´„É©„É† *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-academic">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">üìö</span>
                    <h5 class="mb-0">Á†îÁ©∂</h5>
                </div>

                @if (academicTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in academicTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                <div class="category-articles">
                    @if (!academicArticles.Any())
                    {
                        <div class="empty-state">
                            <p class="mb-0">„Åä„Åô„Åô„ÇÅË®ò‰∫ã„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                        </div>
                    }
                    else
                    {
                        foreach (var article in academicArticles)
                        {
                            <div class="article-item" @key="article.Id">
                                <div class="d-flex gap-2">
                                    <span style="font-size: 1rem;">üî•</span>
                                    <div class="flex-grow-1">
                                        <a href="@article.Url" target="_blank"
                                           class="article-title text-decoration-none d-block"
                                           title="@GetTooltipText(article)">
                                            @article.Title
                                        </a>
                                        <div class="article-meta d-flex gap-2 mt-1">
                                            <span>@article.Source.Name</span>
                                            @if (article.PublishedAt.HasValue)
                                            {
                                                <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @if (academicArticles.Count < academicTotalCount)
                    {
                        <div class="load-more-btn">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadMoreAcademic" disabled="@isLoadingMoreAcademic">
                                @if (isLoadingMoreAcademic)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                @{
                                    var academicRemaining = academicTotalCount - academicArticles.Count;
                                    var academicLoadCount = Math.Min(academicRemaining, PageSize);
                                }
                                „ÇÇ„Å£„Å®Ë¶ã„ÇãÔºàÊ¨°„ÅÆ @academicLoadCount ‰ª∂Ôºâ
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? KeywordParam { get; set; }

    private List<Keyword> keywords = new();
    private int? selectedKeywordId;
    private bool isLoading = true;
    private DateTime weekStart;
    private DateTime weekEnd;

    // „Ç´„ÉÜ„Ç¥„É™Âà•Ë®ò‰∫ãÔºà„É™„Çπ„Éà„Å´Â§âÊõ¥„Åó„Å¶„Ç§„É≥„ÇØ„É™„É°„É≥„Çø„É´„É≠„Éº„ÉâÂØæÂøúÔºâ
    private List<Article> newsArticles = new();
    private List<Article> techArticles = new();
    private List<Article> academicArticles = new();

    // „Ç´„ÉÜ„Ç¥„É™Âà•„ÅÆÁ∑è‰ª∂Êï∞
    private int newsTotalCount = 0;
    private int techTotalCount = 0;
    private int academicTotalCount = 0;

    // „ÇÇ„Å£„Å®Ë¶ã„Çã„Éú„Çø„É≥„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖã
    private bool isLoadingMoreNews = false;
    private bool isLoadingMoreTech = false;
    private bool isLoadingMoreAcademic = false;

    // „Éà„É¨„É≥„Éâ„Çø„Ç∞ÔºàÂæå„ÅßÂÆüË£ÖÔºâ
    private List<string> newsTrendTags = new();
    private List<string> techTrendTags = new();
    private List<string> academicTrendTags = new();

    // „Éö„Éº„Ç∏„É≥„Ç∞„ÅÆÂÆöÊï∞
    private const int PageSize = 10;

    // „Çµ„Éû„É™„ÉºÈñ¢ÈÄ£
    private Core.Entities.WeeklySummary? currentSummary;
    private SummaryDiagnostics? diagnostics;
    private bool isLoadingSummary = false;
    private bool isGenerating = false;
    private string? generateError;

    // Â±•Ê≠¥„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Èñ¢ÈÄ£
    private bool hasPreviousSummary = false;
    private bool hasNextSummary = false;
    private bool isLatestSummary = true;
    private bool isNavigating = false;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseAutoLinks()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        CalculateWeekRange();
        keywords = (await KeywordService.GetActiveAsync()).ToList();
        ResolveKeywordFromUrl();
        await LoadAll();
    }

    protected override async Task OnParametersSetAsync()
    {
        // URL„Éë„É©„É°„Éº„Çø„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Å®„Åç„Å´ÂÜçË™≠„ÅøËæº„Åø
        var previousKeywordId = selectedKeywordId;
        ResolveKeywordFromUrl();

        if (previousKeywordId != selectedKeywordId)
        {
            await LoadAll();
        }
    }

    private void ResolveKeywordFromUrl()
    {
        if (string.IsNullOrEmpty(KeywordParam))
        {
            // „Ç≠„Éº„ÉØ„Éº„Éâ„Éë„É©„É°„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄÂàù„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíËá™ÂãïÈÅ∏Êäû
            selectedKeywordId = keywords.FirstOrDefault()?.Id;
            return;
        }

        // URL„Éá„Ç≥„Éº„Éâ
        var decodedParam = Uri.UnescapeDataString(KeywordParam);

        // „Åæ„ÅöSlug„ÅßÊ§úÁ¥¢
        var keyword = keywords.FirstOrDefault(k =>
            !string.IsNullOrEmpty(k.Slug) && k.Slug.Equals(decodedParam, StringComparison.OrdinalIgnoreCase));

        // Slug„ÅßË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞ID„ÅßÊ§úÁ¥¢
        if (keyword == null && int.TryParse(decodedParam, out var id))
        {
            keyword = keywords.FirstOrDefault(k => k.Id == id);
        }

        // „Åù„Çå„Åß„ÇÇË¶ã„Å§„Åã„Çâ„Å™„Åë„Çå„Å∞TermÂêç„ÅßÊ§úÁ¥¢ÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
        if (keyword == null)
        {
            keyword = keywords.FirstOrDefault(k =>
                k.Term.Equals(decodedParam, StringComparison.OrdinalIgnoreCase));
        }

        selectedKeywordId = keyword?.Id;
    }

    private void CalculateWeekRange()
    {
        // ÈÅéÂéª7Êó•ÈñìÊñπÂºèÔºöÂ∏∏„Å´‰ªäÊó•„Åã„Çâ6Êó•Ââç„Äú‰ªäÊó•„ÇíÂØæË±°„Å®„Åô„Çã
        var today = DateTime.UtcNow.Date;
        weekStart = today.AddDays(-6);
        weekEnd = today;
    }

    private async Task LoadAll()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // „Çµ„Éû„É™„Éº„ÇíÂÖà„Å´„É≠„Éº„Éâ„Åó„Å¶„ÄÅ„Åù„ÅÆÈÄ±ÁØÑÂõ≤„Çí‰Ωø„Å£„Å¶„Ç´„ÉÜ„Ç¥„É™Âà•Ë®ò‰∫ã„ÇíÂèñÂæó
            await LoadSummary();
            await LoadCategoryArticles();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private const int RecommendThreshold = 17;  // „Åä„Åô„Åô„ÇÅË°®Á§∫„ÅÆÈñæÂÄ§Ôºà0-20Ôºâ

    private async Task LoadCategoryArticles()
    {
        // Â∏∏„Å´„ÄåÈÅéÂéª7Êó•Èñì„Äç„Çí‰ΩøÁî®Ôºà„Çµ„Éû„É™„Éº„ÅÆÈÄ±ÁØÑÂõ≤„Å´‰æùÂ≠ò„Åó„Å™„ÅÑÔºâ
        // weekStart/weekEnd „Å´ null „ÇíÊ∏°„Åô„Å® ArticleService.GetCurrentWeekRange() „Åå‰Ωø„Çè„Çå„Çã

        // DbContext „ÅØ„Çπ„É¨„ÉÉ„Éâ„Çª„Éº„Éï„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅÈ†ÜÊ¨°ÂÆüË°å
        // ÂàùÊúü„É≠„Éº„ÉâÔºöÊúÄÂàù„ÅÆPageSize‰ª∂„ÇíÂèñÂæó
        var newsItems = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.News, RecommendThreshold, selectedKeywordId, 0, PageSize);
        newsArticles = newsItems.ToList();
        newsTotalCount = await ArticleService.GetWeeklyRecommendedCountByCategoryAsync(SourceCategory.News, RecommendThreshold, selectedKeywordId);

        var techItems = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.Technology, RecommendThreshold, selectedKeywordId, 0, PageSize);
        techArticles = techItems.ToList();
        techTotalCount = await ArticleService.GetWeeklyRecommendedCountByCategoryAsync(SourceCategory.Technology, RecommendThreshold, selectedKeywordId);

        var academicItems = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.Academic, RecommendThreshold, selectedKeywordId, 0, PageSize);
        academicArticles = academicItems.ToList();
        academicTotalCount = await ArticleService.GetWeeklyRecommendedCountByCategoryAsync(SourceCategory.Academic, RecommendThreshold, selectedKeywordId);

        // „Éà„É¨„É≥„Éâ„Çø„Ç∞„ÇíÊäΩÂá∫Ôºà„Ç∑„É≥„Éó„É´ÁâàÔºö„Çø„Ç§„Éà„É´„Åã„ÇâÈ†ªÂá∫ÂçòË™û„ÇíÊäΩÂá∫Ôºâ
        newsTrendTags = ExtractSimpleTrendTags(newsArticles);
        techTrendTags = ExtractSimpleTrendTags(techArticles);
        academicTrendTags = ExtractSimpleTrendTags(academicArticles);
    }

    private async Task LoadMoreNews()
    {
        if (isLoadingMoreNews || newsArticles.Count >= newsTotalCount) return;

        isLoadingMoreNews = true;
        StateHasChanged();

        try
        {
            var moreArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(
                SourceCategory.News, RecommendThreshold, selectedKeywordId, newsArticles.Count, PageSize);
            newsArticles.AddRange(moreArticles);
        }
        finally
        {
            isLoadingMoreNews = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreTech()
    {
        if (isLoadingMoreTech || techArticles.Count >= techTotalCount) return;

        isLoadingMoreTech = true;
        StateHasChanged();

        try
        {
            var moreArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(
                SourceCategory.Technology, RecommendThreshold, selectedKeywordId, techArticles.Count, PageSize);
            techArticles.AddRange(moreArticles);
        }
        finally
        {
            isLoadingMoreTech = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreAcademic()
    {
        if (isLoadingMoreAcademic || academicArticles.Count >= academicTotalCount) return;

        isLoadingMoreAcademic = true;
        StateHasChanged();

        try
        {
            var moreArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(
                SourceCategory.Academic, RecommendThreshold, selectedKeywordId, academicArticles.Count, PageSize);
            academicArticles.AddRange(moreArticles);
        }
        finally
        {
            isLoadingMoreAcademic = false;
            StateHasChanged();
        }
    }

    private List<string> ExtractSimpleTrendTags(IEnumerable<Article> articles)
    {
        if (!articles.Any()) return new List<string>();

        // „Çø„Ç§„Éà„É´„Åã„ÇâÂçòË™û„ÇíÊäΩÂá∫„Åó„ÄÅÈ†ªÂá∫‰∏ä‰Ωç„ÇíËøî„ÅôÔºà„Ç∑„É≥„Éó„É´ÁâàÔºâ
        var words = articles
            .SelectMany(a => ExtractKeywords(a.Title))
            .GroupBy(w => w)
            .OrderByDescending(g => g.Count())
            .Take(3)
            .Select(g => g.Key)
            .ToList();

        return words;
    }

    private IEnumerable<string> ExtractKeywords(string title)
    {
        // Á∞°ÊòìÁöÑ„Å™„Ç≠„Éº„ÉØ„Éº„ÉâÊäΩÂá∫ÔºàËã±ÂçòË™û„Å®Êó•Êú¨Ë™û„ÅÆ‰∏ÄÈÉ®„ÇíÊäΩÂá∫Ôºâ
        var words = new List<string>();

        // Ëã±ÂçòË™ûÔºà3ÊñáÂ≠ó‰ª•‰∏äÔºâ
        var englishPattern = new System.Text.RegularExpressions.Regex(@"\b[A-Za-z]{3,}\b");
        var matches = englishPattern.Matches(title);
        foreach (System.Text.RegularExpressions.Match match in matches)
        {
            var word = match.Value;
            // ‰∏ÄËà¨ÁöÑ„Å™ÂçòË™û„ÅØÈô§Â§ñ
            if (!IsCommonWord(word))
            {
                words.Add(word);
            }
        }

        return words;
    }

    private bool IsCommonWord(string word)
    {
        var commonWords = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "the", "and", "for", "with", "from", "that", "this", "are", "was", "were",
            "have", "has", "had", "been", "being", "will", "would", "could", "should",
            "can", "may", "might", "must", "shall", "into", "about", "over", "after",
            "before", "under", "between", "through", "during", "without", "within",
            "new", "how", "why", "what", "when", "where", "which", "who", "whom",
            "using", "use", "used", "based", "make", "made", "get", "got", "set"
        };
        return commonWords.Contains(word);
    }

    private async Task LoadSummary()
    {
        if (!selectedKeywordId.HasValue)
        {
            currentSummary = null;
            diagnostics = null;
            ResetHistoryNavigation();
            return;
        }

        isLoadingSummary = true;
        generateError = null;

        try
        {
            // ÊúÄÊñ∞„ÅÆË¶ÅÁ¥Ñ„ÇíÂèñÂæó
            currentSummary = await SummaryService.GetLatestSummaryAsync(selectedKeywordId.Value);

            // „Çµ„Éû„É™„Éº„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË®∫Êñ≠ÊÉÖÂ†±„ÇíÂèñÂæó
            if (currentSummary == null)
            {
                diagnostics = await SummaryService.GetDiagnosticsAsync(selectedKeywordId.Value);
                ResetHistoryNavigation();
            }
            else
            {
                diagnostics = null;
                await UpdateHistoryNavigationState();
            }
        }
        finally
        {
            isLoadingSummary = false;
        }
    }

    private void ResetHistoryNavigation()
    {
        hasPreviousSummary = false;
        hasNextSummary = false;
        isLatestSummary = true;
    }

    private async Task UpdateHistoryNavigationState()
    {
        if (!selectedKeywordId.HasValue || currentSummary == null)
        {
            ResetHistoryNavigation();
            return;
        }

        // ÂâçÂæå„ÅÆË¶ÅÁ¥Ñ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        var previousSummary = await SummaryService.GetPreviousSummaryAsync(
            selectedKeywordId.Value, currentSummary.GeneratedAt);
        var nextSummary = await SummaryService.GetNextSummaryAsync(
            selectedKeywordId.Value, currentSummary.GeneratedAt);

        hasPreviousSummary = previousSummary != null;
        hasNextSummary = nextSummary != null;

        // ÊúÄÊñ∞„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
        var latestSummary = await SummaryService.GetLatestSummaryAsync(selectedKeywordId.Value);
        isLatestSummary = latestSummary != null && latestSummary.Id == currentSummary.Id;
    }

    private async Task GenerateSummary()
    {
        if (!selectedKeywordId.HasValue) return;

        isGenerating = true;
        generateError = null;
        StateHasChanged();

        try
        {
            currentSummary = await SummaryService.GenerateSummaryAsync(selectedKeywordId.Value);
            diagnostics = null; // ÊàêÂäü„Åó„Åü„ÇâË®∫Êñ≠ÊÉÖÂ†±„Çí„ÇØ„É™„Ç¢
        }
        catch (InvalidOperationException ex)
        {
            // ÂâçÊèêÊù°‰ª∂„Ç®„É©„ÉºÔºàË®ò‰∫ãÊï∞‰∏çË∂≥„Å™„Å©Ôºâ
            generateError = ex.Message;
            // Ë®∫Êñ≠ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            diagnostics = await SummaryService.GetDiagnosticsAsync(selectedKeywordId.Value);
        }
        catch (Exception ex)
        {
            // „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„ÉºÔºàAPIÊé•Á∂ö„Ç®„É©„Éº„Å™„Å©Ôºâ
            generateError = $"ÁîüÊàê„Ç®„É©„Éº: {ex.Message}";
            // Ë®∫Êñ≠ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            diagnostics = await SummaryService.GetDiagnosticsAsync(selectedKeywordId.Value);
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task RegenerateSummary()
    {
        // Êó¢Â≠ò„Çµ„Éû„É™„Éº„Åå„ÅÇ„Å£„Å¶„ÇÇÂÜçÁîüÊàêÔºàÊñ∞„Åó„ÅÑË¶ÅÁ¥Ñ„Å®„Åó„Å¶ËøΩÂä†Ôºâ
        await GenerateSummary();
        // ÁîüÊàêÂæå„ÄÅÂ±•Ê≠¥„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥Áä∂ÊÖã„ÇíÊõ¥Êñ∞
        await UpdateHistoryNavigationState();
    }

    private async Task GoToPreviousSummary()
    {
        if (!selectedKeywordId.HasValue || currentSummary == null) return;

        isNavigating = true;
        StateHasChanged();

        try
        {
            var previousSummary = await SummaryService.GetPreviousSummaryAsync(
                selectedKeywordId.Value, currentSummary.GeneratedAt);

            if (previousSummary != null)
            {
                currentSummary = previousSummary;
                await UpdateHistoryNavigationState();
            }
        }
        finally
        {
            isNavigating = false;
            StateHasChanged();
        }
    }

    private async Task GoToNextSummary()
    {
        if (!selectedKeywordId.HasValue || currentSummary == null) return;

        isNavigating = true;
        StateHasChanged();

        try
        {
            var nextSummary = await SummaryService.GetNextSummaryAsync(
                selectedKeywordId.Value, currentSummary.GeneratedAt);

            if (nextSummary != null)
            {
                currentSummary = nextSummary;
                await UpdateHistoryNavigationState();
            }
        }
        finally
        {
            isNavigating = false;
            StateHasChanged();
        }
    }

    private static string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown)) return string.Empty;

        // Markdown„É™„É≥„ÇØ„ÅÆURL„Å´Âê´„Åæ„Çå„ÇãÁ©∫ÁôΩ„Çí„Éà„É™„É†
        // „Éë„Çø„Éº„É≥: [text](url) -> URL„ÅÆÂâçÂæå„ÅÆÁ©∫ÁôΩ„ÇíÈô§Âéª
        markdown = TrimMarkdownLinkUrls(markdown);

        var html = Markdown.ToHtml(markdown, _markdownPipeline);
        html = html.Replace("<a href=", "<a target=\"_blank\" rel=\"noopener noreferrer\" href=");
        return html;
    }

    private static readonly System.Text.RegularExpressions.Regex _markdownLinkRegex =
        new(@"\[([^\]]+)\]\(\s*([^\s\)]+)\s*\)", System.Text.RegularExpressions.RegexOptions.Compiled);

    private static string TrimMarkdownLinkUrls(string markdown)
    {
        // [text]( url ) -> [text](url) „ÅÆ„Çà„ÅÜ„Å´URL„ÅÆÁ©∫ÁôΩ„Çí„Éà„É™„É†
        return _markdownLinkRegex.Replace(markdown, match =>
        {
            var text = match.Groups[1].Value;
            var url = match.Groups[2].Value.Trim();
            return $"[{text}]({url})";
        });
    }

    private static string? GetTooltipText(Article article)
    {
        // Êó•Êú¨Ë™ûË¶ÅÁ¥Ñ„Åå„ÅÇ„Çå„Å∞„Åù„Çå„ÇíË°®Á§∫„ÄÅ„Å™„Åë„Çå„Å∞null
        if (!string.IsNullOrEmpty(article.SummaryJa))
        {
            // Èï∑„Åô„Åé„ÇãÂ†¥Âêà„ÅØÂàá„ÇäË©∞„ÇÅ„Çã
            var text = article.SummaryJa;
            if (text.Length > 150)
            {
                text = text[..150] + "...";
            }
            return text;
        }
        return null;
    }
}
