@page "/"
@page "/weekly"
@page "/weekly/{KeywordParam?}"
@attribute [AllowAnonymous]
@rendermode InteractiveServer
@using QInfoRanker.Core.Entities
@using QInfoRanker.Core.Enums
@using QInfoRanker.Core.Interfaces.Services
@using Markdig
@inject IArticleService ArticleService
@inject IKeywordService KeywordService
@inject IWeeklySummaryService SummaryService
@inject NavigationManager NavigationManager

<PageTitle>ä»Šé€±ã®ãŠã™ã™ã‚ - QInfoRanker</PageTitle>

<style>
    .category-column {
        min-height: 400px;
        max-height: 900px;
        display: flex;
        flex-direction: column;
    }
    .category-articles {
        flex: 1;
        overflow-y: auto;
        padding-right: 0.5rem;
    }
    .load-more-btn {
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        text-align: center;
    }
    .category-header {
        border-bottom: 3px solid;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .category-news .category-header { border-color: #dc3545; }
    .category-tech .category-header { border-color: #0d6efd; }
    .category-academic .category-header { border-color: #198754; }

    .trend-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
        margin-bottom: 1rem;
    }
    .trend-tag {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 1rem;
        background-color: #f8f9fa;
        color: #495057;
        border: 1px solid #dee2e6;
    }

    .article-item {
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }
    .article-item:last-child {
        border-bottom: none;
    }
    .article-item:hover {
        background-color: #f8f9fa;
        margin: 0 -0.5rem;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }
    .article-title {
        font-size: 0.9rem;
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .article-meta {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .summary-card {
        border-left: 4px solid #0d6efd;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
    }
    .summary-content {
        font-size: 0.9rem;
        line-height: 1.6;
    }
    .summary-content a {
        color: #0d6efd;
        text-decoration: none;
    }
    .summary-content a:hover {
        text-decoration: underline;
    }
    .summary-content h2, .summary-content h3 {
        font-size: 1rem;
        margin-top: 0.75rem;
        margin-bottom: 0.5rem;
    }
    .summary-content ul, .summary-content ol {
        margin-bottom: 0.5rem;
        padding-left: 1.25rem;
    }
    .summary-content li {
        margin-bottom: 0.25rem;
    }
    .summary-content p {
        margin-bottom: 0.5rem;
    }

    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }

    .history-nav {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .history-nav .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
    .history-badge {
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 0.25rem;
        background-color: #e9ecef;
        color: #495057;
    }
    .history-badge.latest {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    </style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">ä»Šé€±ã®ãŠã™ã™ã‚</h1>
    <div class="d-flex align-items-center gap-2">
        <div class="btn-group" role="group">
            <a href="/weekly" class="btn btn-sm @(selectedKeywordId == null ? "btn-primary" : "btn-outline-primary")">ã™ã¹ã¦</a>
            @foreach (var keyword in keywords)
            {
                <a href="/weekly/@keyword.GetUrlIdentifier()"
                   class="btn btn-sm @(selectedKeywordId == keyword.Id ? "btn-primary" : "btn-outline-primary")">
                    @keyword.Term
                </a>
            }
        </div>
    </div>
</div>

<p class="text-muted small mb-3">
    @weekStart.ToString("M/d") ã€œ @weekEnd.ToString("M/d") ã®ãŠã™ã™ã‚è¨˜äº‹
</p>

@* çµ±åˆã‚µãƒãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ *@
@if (selectedKeywordId.HasValue)
{
    @if (isLoadingSummary)
    {
        <div class="card summary-card mb-4">
            <div class="card-body text-center py-3">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                ã‚µãƒãƒªãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    }
    else if (currentSummary != null)
    {
        <div class="card summary-card mb-4">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">@currentSummary.Title</h5>
                    <div class="d-flex align-items-center gap-2">
                        @* å±¥æ­´ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ *@
                        <div class="history-nav">
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="GoToPreviousSummary"
                                    disabled="@(!hasPreviousSummary || isNavigating)"
                                    title="å‰ã®è¦ç´„ï¼ˆå¤ã„æ–¹å‘ï¼‰">
                                â†
                            </button>
                            @if (isLatestSummary)
                            {
                                <span class="history-badge latest">æœ€æ–°</span>
                            }
                            else
                            {
                                <span class="history-badge">å±¥æ­´</span>
                            }
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="GoToNextSummary"
                                    disabled="@(!hasNextSummary || isNavigating)"
                                    title="æ¬¡ã®è¦ç´„ï¼ˆæ–°ã—ã„æ–¹å‘ï¼‰">
                                â†’
                            </button>
                        </div>
                        <AuthorizeView>
                            <Authorized>
                                <button class="btn btn-sm btn-outline-secondary" @onclick="RegenerateSummary" disabled="@isGenerating" title="ã‚µãƒãƒªãƒ¼ã‚’å†ç”Ÿæˆ">
                                    @if (isGenerating)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                    }
                                    else
                                    {
                                        <span>+</span>
                                    }
                                </button>
                            </Authorized>
                        </AuthorizeView>
                    </div>
                </div>
                <div class="summary-content">
                    @((MarkupString)RenderMarkdown(currentSummary.Content))
                </div>
                <div class="mt-2 small text-muted d-flex justify-content-between align-items-center">
                    <span>@currentSummary.ArticleCount ä»¶ã®è¨˜äº‹ã‚’å‚ç…§</span>
                    <span>
                        @currentSummary.WeekStart.ToString("M/d")ã€œ@currentSummary.WeekEnd.ToString("M/d") |
                        ç”Ÿæˆ: @currentSummary.GeneratedAt.ToLocalTime().ToString("M/d HH:mm")
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(generateError))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-2 small">@generateError</div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="card summary-card mb-4">
            <div class="card-body py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-muted">
                        ã“ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é€±é–“ã‚µãƒãƒªãƒ¼ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“
                    </span>
                    <button class="btn btn-sm btn-outline-primary" @onclick="GenerateSummary" disabled="@(isGenerating || (diagnostics != null && !diagnostics.CanGenerateSummary))">
                        @if (isGenerating)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>ç”Ÿæˆä¸­...</span>
                        }
                        else
                        {
                            <span>ã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆ</span>
                        }
                    </button>
                </div>
                @if (diagnostics != null)
                {
                    <div class="mt-3 small">
                        <div class="d-flex flex-wrap gap-3 text-muted mb-2">
                            <span title="Azure OpenAIè¨­å®šçŠ¶æ…‹">
                                @if (diagnostics.IsAzureOpenAIConfigured)
                                {
                                    <span class="text-success">AI: è¨­å®šæ¸ˆã¿ (@diagnostics.DeploymentName)</span>
                                }
                                else
                                {
                                    <span class="text-danger">AI: æœªè¨­å®š</span>
                                }
                            </span>
                            <span title="ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ¸ˆã¿è¨˜äº‹æ•°">
                                è¨˜äº‹: @(diagnostics.TotalArticleCount)ä»¶
                                (ãƒ‹ãƒ¥ãƒ¼ã‚¹ @(diagnostics.NewsArticleCount) / æŠ€è¡“ @(diagnostics.TechArticleCount) / ç ”ç©¶ @(diagnostics.AcademicArticleCount))
                            </span>
                            <span title="å¿…è¦ãªæœ€ä½è¨˜äº‹æ•°">
                                å¿…è¦: @(diagnostics.MinRequiredArticles)ä»¶ä»¥ä¸Š
                            </span>
                        </div>
                        @if (!diagnostics.CanGenerateSummary && !string.IsNullOrEmpty(diagnostics.BlockingReason))
                        {
                            <div class="alert alert-warning py-2 mb-0">
                                <strong>ç”Ÿæˆã§ããªã„ç†ç”±:</strong> @diagnostics.BlockingReason
                            </div>
                        }
                    </div>
                }
                @if (!string.IsNullOrEmpty(generateError))
                {
                    <div class="alert alert-danger mt-2 mb-0 py-2 small">@generateError</div>
                }
            </div>
        </div>
    }
}

@* 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ *@
@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        @* ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚«ãƒ©ãƒ  *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-news">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">ğŸ“°</span>
                    <h5 class="mb-0">ãƒ‹ãƒ¥ãƒ¼ã‚¹</h5>
                    <small class="text-muted ms-auto">@newsArticles.Count / @newsTotalCount ä»¶</small>
                </div>

                @if (newsTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in newsTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                <div class="category-articles">
                    @if (!newsArticles.Any())
                    {
                        <div class="empty-state">
                            <p class="mb-0">ãŠã™ã™ã‚è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    }
                    else
                    {
                        foreach (var article in newsArticles)
                        {
                            <div class="article-item" @key="article.Id">
                                <div class="d-flex gap-2">
                                    <span style="font-size: 1rem;">ğŸ”¥</span>
                                    <div class="flex-grow-1">
                                        <a href="@article.Url" target="_blank"
                                           class="article-title text-decoration-none d-block"
                                           title="@GetTooltipText(article)">
                                            @article.Title
                                        </a>
                                        <div class="article-meta d-flex gap-2 mt-1">
                                            <span>@article.Source.Name</span>
                                            @if (article.PublishedAt.HasValue)
                                            {
                                                <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @if (newsArticles.Count < newsTotalCount)
                    {
                        <div class="load-more-btn">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadMoreNews" disabled="@isLoadingMoreNews">
                                @if (isLoadingMoreNews)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                @{
                                    var newsRemaining = newsTotalCount - newsArticles.Count;
                                    var newsLoadCount = Math.Min(newsRemaining, PageSize);
                                }
                                ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ¬¡ã® @newsLoadCount ä»¶ï¼‰
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* æŠ€è¡“è¨˜äº‹ã‚«ãƒ©ãƒ  *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-tech">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">ğŸ’»</span>
                    <h5 class="mb-0">æŠ€è¡“è¨˜äº‹</h5>
                    <small class="text-muted ms-auto">@techArticles.Count / @techTotalCount ä»¶</small>
                </div>

                @if (techTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in techTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                <div class="category-articles">
                    @if (!techArticles.Any())
                    {
                        <div class="empty-state">
                            <p class="mb-0">ãŠã™ã™ã‚è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    }
                    else
                    {
                        foreach (var article in techArticles)
                        {
                            <div class="article-item" @key="article.Id">
                                <div class="d-flex gap-2">
                                    <span style="font-size: 1rem;">ğŸ”¥</span>
                                    <div class="flex-grow-1">
                                        <a href="@article.Url" target="_blank"
                                           class="article-title text-decoration-none d-block"
                                           title="@GetTooltipText(article)">
                                            @article.Title
                                        </a>
                                        <div class="article-meta d-flex gap-2 mt-1">
                                            <span>@article.Source.Name</span>
                                            @if (article.PublishedAt.HasValue)
                                            {
                                                <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @if (techArticles.Count < techTotalCount)
                    {
                        <div class="load-more-btn">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadMoreTech" disabled="@isLoadingMoreTech">
                                @if (isLoadingMoreTech)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                @{
                                    var techRemaining = techTotalCount - techArticles.Count;
                                    var techLoadCount = Math.Min(techRemaining, PageSize);
                                }
                                ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ¬¡ã® @techLoadCount ä»¶ï¼‰
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>

        @* ç ”ç©¶ã‚«ãƒ©ãƒ  *@
        <div class="col-lg-4 mb-4">
            <div class="category-column category-academic">
                <div class="category-header d-flex align-items-center gap-2">
                    <span style="font-size: 1.25rem;">ğŸ“š</span>
                    <h5 class="mb-0">ç ”ç©¶</h5>
                    <small class="text-muted ms-auto">@academicArticles.Count / @academicTotalCount ä»¶</small>
                </div>

                @if (academicTrendTags.Any())
                {
                    <div class="trend-tags">
                        @foreach (var tag in academicTrendTags)
                        {
                            <span class="trend-tag">#@tag</span>
                        }
                    </div>
                }

                <div class="category-articles">
                    @if (!academicArticles.Any())
                    {
                        <div class="empty-state">
                            <p class="mb-0">ãŠã™ã™ã‚è¨˜äº‹ã¯ã‚ã‚Šã¾ã›ã‚“</p>
                        </div>
                    }
                    else
                    {
                        foreach (var article in academicArticles)
                        {
                            <div class="article-item" @key="article.Id">
                                <div class="d-flex gap-2">
                                    <span style="font-size: 1rem;">ğŸ”¥</span>
                                    <div class="flex-grow-1">
                                        <a href="@article.Url" target="_blank"
                                           class="article-title text-decoration-none d-block"
                                           title="@GetTooltipText(article)">
                                            @article.Title
                                        </a>
                                        <div class="article-meta d-flex gap-2 mt-1">
                                            <span>@article.Source.Name</span>
                                            @if (article.PublishedAt.HasValue)
                                            {
                                                <span>@article.PublishedAt.Value.ToString("M/d")</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    @if (academicArticles.Count < academicTotalCount)
                    {
                        <div class="load-more-btn">
                            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadMoreAcademic" disabled="@isLoadingMoreAcademic">
                                @if (isLoadingMoreAcademic)
                                {
                                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                }
                                @{
                                    var academicRemaining = academicTotalCount - academicArticles.Count;
                                    var academicLoadCount = Math.Min(academicRemaining, PageSize);
                                }
                                ã‚‚ã£ã¨è¦‹ã‚‹ï¼ˆæ¬¡ã® @academicLoadCount ä»¶ï¼‰
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? KeywordParam { get; set; }

    private List<Keyword> keywords = new();
    private int? selectedKeywordId;
    private bool isLoading = true;
    private DateTime weekStart;
    private DateTime weekEnd;

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥è¨˜äº‹ï¼ˆãƒªã‚¹ãƒˆã«å¤‰æ›´ã—ã¦ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ã‚¿ãƒ«ãƒ­ãƒ¼ãƒ‰å¯¾å¿œï¼‰
    private List<Article> newsArticles = new();
    private List<Article> techArticles = new();
    private List<Article> academicArticles = new();

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ç·ä»¶æ•°
    private int newsTotalCount = 0;
    private int techTotalCount = 0;
    private int academicTotalCount = 0;

    // ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
    private bool isLoadingMoreNews = false;
    private bool isLoadingMoreTech = false;
    private bool isLoadingMoreAcademic = false;

    // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚°ï¼ˆå¾Œã§å®Ÿè£…ï¼‰
    private List<string> newsTrendTags = new();
    private List<string> techTrendTags = new();
    private List<string> academicTrendTags = new();

    // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã®å®šæ•°
    private const int PageSize = 10;

    // ã‚µãƒãƒªãƒ¼é–¢é€£
    private Core.Entities.WeeklySummary? currentSummary;
    private SummaryDiagnostics? diagnostics;
    private bool isLoadingSummary = false;
    private bool isGenerating = false;
    private string? generateError;

    // å±¥æ­´ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£
    private bool hasPreviousSummary = false;
    private bool hasNextSummary = false;
    private bool isLatestSummary = true;
    private bool isNavigating = false;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseAutoLinks()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        CalculateWeekRange();
        keywords = (await KeywordService.GetActiveAsync()).ToList();
        ResolveKeywordFromUrl();
        await LoadAll();
    }

    protected override async Task OnParametersSetAsync()
    {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«å†èª­ã¿è¾¼ã¿
        var previousKeywordId = selectedKeywordId;
        ResolveKeywordFromUrl();

        if (previousKeywordId != selectedKeywordId)
        {
            await LoadAll();
        }
    }

    private void ResolveKeywordFromUrl()
    {
        if (string.IsNullOrEmpty(KeywordParam))
        {
            selectedKeywordId = null;
            return;
        }

        // URLãƒ‡ã‚³ãƒ¼ãƒ‰
        var decodedParam = Uri.UnescapeDataString(KeywordParam);

        // ã¾ãšSlugã§æ¤œç´¢
        var keyword = keywords.FirstOrDefault(k =>
            !string.IsNullOrEmpty(k.Slug) && k.Slug.Equals(decodedParam, StringComparison.OrdinalIgnoreCase));

        // Slugã§è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°IDã§æ¤œç´¢
        if (keyword == null && int.TryParse(decodedParam, out var id))
        {
            keyword = keywords.FirstOrDefault(k => k.Id == id);
        }

        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°Termåã§æ¤œç´¢ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        if (keyword == null)
        {
            keyword = keywords.FirstOrDefault(k =>
                k.Term.Equals(decodedParam, StringComparison.OrdinalIgnoreCase));
        }

        selectedKeywordId = keyword?.Id;
    }

    private void CalculateWeekRange()
    {
        var today = DateTime.UtcNow.Date;
        var diff = (7 + (today.DayOfWeek - DayOfWeek.Monday)) % 7;
        weekStart = today.AddDays(-diff);
        weekEnd = weekStart.AddDays(6);
    }

    private async Task LoadAll()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // DbContext ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªã„ãŸã‚é †æ¬¡å®Ÿè¡Œ
            await LoadCategoryArticles();
            await LoadSummary();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private const int RecommendThreshold = 10;  // ãŠã™ã™ã‚è¡¨ç¤ºã®é–¾å€¤ï¼ˆ0-20ï¼‰ã€17ã¯å³ã—ã™ããŸãŸã‚ç·©å’Œ

    private async Task LoadCategoryArticles()
    {
        // DbContext ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ã§ã¯ãªã„ãŸã‚é †æ¬¡å®Ÿè¡Œ
        // åˆæœŸãƒ­ãƒ¼ãƒ‰ï¼šæœ€åˆã®PageSizeä»¶ã‚’å–å¾—
        var newsItems = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.News, RecommendThreshold, selectedKeywordId, 0, PageSize);
        newsArticles = newsItems.ToList();
        newsTotalCount = await ArticleService.GetWeeklyRecommendedCountByCategoryAsync(SourceCategory.News, RecommendThreshold, selectedKeywordId);

        var techItems = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.Technology, RecommendThreshold, selectedKeywordId, 0, PageSize);
        techArticles = techItems.ToList();
        techTotalCount = await ArticleService.GetWeeklyRecommendedCountByCategoryAsync(SourceCategory.Technology, RecommendThreshold, selectedKeywordId);

        var academicItems = await ArticleService.GetWeeklyRecommendedByCategoryAsync(SourceCategory.Academic, RecommendThreshold, selectedKeywordId, 0, PageSize);
        academicArticles = academicItems.ToList();
        academicTotalCount = await ArticleService.GetWeeklyRecommendedCountByCategoryAsync(SourceCategory.Academic, RecommendThreshold, selectedKeywordId);

        // ãƒˆãƒ¬ãƒ³ãƒ‰ã‚¿ã‚°ã‚’æŠ½å‡ºï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼šã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰é »å‡ºå˜èªã‚’æŠ½å‡ºï¼‰
        newsTrendTags = ExtractSimpleTrendTags(newsArticles);
        techTrendTags = ExtractSimpleTrendTags(techArticles);
        academicTrendTags = ExtractSimpleTrendTags(academicArticles);
    }

    private async Task LoadMoreNews()
    {
        if (isLoadingMoreNews || newsArticles.Count >= newsTotalCount) return;

        isLoadingMoreNews = true;
        StateHasChanged();

        try
        {
            var moreArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(
                SourceCategory.News, RecommendThreshold, selectedKeywordId, newsArticles.Count, PageSize);
            newsArticles.AddRange(moreArticles);
        }
        finally
        {
            isLoadingMoreNews = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreTech()
    {
        if (isLoadingMoreTech || techArticles.Count >= techTotalCount) return;

        isLoadingMoreTech = true;
        StateHasChanged();

        try
        {
            var moreArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(
                SourceCategory.Technology, RecommendThreshold, selectedKeywordId, techArticles.Count, PageSize);
            techArticles.AddRange(moreArticles);
        }
        finally
        {
            isLoadingMoreTech = false;
            StateHasChanged();
        }
    }

    private async Task LoadMoreAcademic()
    {
        if (isLoadingMoreAcademic || academicArticles.Count >= academicTotalCount) return;

        isLoadingMoreAcademic = true;
        StateHasChanged();

        try
        {
            var moreArticles = await ArticleService.GetWeeklyRecommendedByCategoryAsync(
                SourceCategory.Academic, RecommendThreshold, selectedKeywordId, academicArticles.Count, PageSize);
            academicArticles.AddRange(moreArticles);
        }
        finally
        {
            isLoadingMoreAcademic = false;
            StateHasChanged();
        }
    }

    private List<string> ExtractSimpleTrendTags(IEnumerable<Article> articles)
    {
        if (!articles.Any()) return new List<string>();

        // ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰å˜èªã‚’æŠ½å‡ºã—ã€é »å‡ºä¸Šä½ã‚’è¿”ã™ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        var words = articles
            .SelectMany(a => ExtractKeywords(a.Title))
            .GroupBy(w => w)
            .OrderByDescending(g => g.Count())
            .Take(3)
            .Select(g => g.Key)
            .ToList();

        return words;
    }

    private IEnumerable<string> ExtractKeywords(string title)
    {
        // ç°¡æ˜“çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆè‹±å˜èªã¨æ—¥æœ¬èªã®ä¸€éƒ¨ã‚’æŠ½å‡ºï¼‰
        var words = new List<string>();

        // è‹±å˜èªï¼ˆ3æ–‡å­—ä»¥ä¸Šï¼‰
        var englishPattern = new System.Text.RegularExpressions.Regex(@"\b[A-Za-z]{3,}\b");
        var matches = englishPattern.Matches(title);
        foreach (System.Text.RegularExpressions.Match match in matches)
        {
            var word = match.Value;
            // ä¸€èˆ¬çš„ãªå˜èªã¯é™¤å¤–
            if (!IsCommonWord(word))
            {
                words.Add(word);
            }
        }

        return words;
    }

    private bool IsCommonWord(string word)
    {
        var commonWords = new HashSet<string>(StringComparer.OrdinalIgnoreCase)
        {
            "the", "and", "for", "with", "from", "that", "this", "are", "was", "were",
            "have", "has", "had", "been", "being", "will", "would", "could", "should",
            "can", "may", "might", "must", "shall", "into", "about", "over", "after",
            "before", "under", "between", "through", "during", "without", "within",
            "new", "how", "why", "what", "when", "where", "which", "who", "whom",
            "using", "use", "used", "based", "make", "made", "get", "got", "set"
        };
        return commonWords.Contains(word);
    }

    private async Task LoadSummary()
    {
        if (!selectedKeywordId.HasValue)
        {
            currentSummary = null;
            diagnostics = null;
            ResetHistoryNavigation();
            return;
        }

        isLoadingSummary = true;
        generateError = null;

        try
        {
            // æœ€æ–°ã®è¦ç´„ã‚’å–å¾—
            currentSummary = await SummaryService.GetLatestSummaryAsync(selectedKeywordId.Value);

            // ã‚µãƒãƒªãƒ¼ãŒãªã„å ´åˆã¯è¨ºæ–­æƒ…å ±ã‚’å–å¾—
            if (currentSummary == null)
            {
                diagnostics = await SummaryService.GetDiagnosticsAsync(selectedKeywordId.Value);
                ResetHistoryNavigation();
            }
            else
            {
                diagnostics = null;
                await UpdateHistoryNavigationState();
            }
        }
        finally
        {
            isLoadingSummary = false;
        }
    }

    private void ResetHistoryNavigation()
    {
        hasPreviousSummary = false;
        hasNextSummary = false;
        isLatestSummary = true;
    }

    private async Task UpdateHistoryNavigationState()
    {
        if (!selectedKeywordId.HasValue || currentSummary == null)
        {
            ResetHistoryNavigation();
            return;
        }

        // å‰å¾Œã®è¦ç´„ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        var previousSummary = await SummaryService.GetPreviousSummaryAsync(
            selectedKeywordId.Value, currentSummary.GeneratedAt);
        var nextSummary = await SummaryService.GetNextSummaryAsync(
            selectedKeywordId.Value, currentSummary.GeneratedAt);

        hasPreviousSummary = previousSummary != null;
        hasNextSummary = nextSummary != null;

        // æœ€æ–°ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        var latestSummary = await SummaryService.GetLatestSummaryAsync(selectedKeywordId.Value);
        isLatestSummary = latestSummary != null && latestSummary.Id == currentSummary.Id;
    }

    private async Task GenerateSummary()
    {
        if (!selectedKeywordId.HasValue) return;

        isGenerating = true;
        generateError = null;
        StateHasChanged();

        try
        {
            currentSummary = await SummaryService.GenerateSummaryAsync(selectedKeywordId.Value);
            diagnostics = null; // æˆåŠŸã—ãŸã‚‰è¨ºæ–­æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
        }
        catch (InvalidOperationException ex)
        {
            // å‰ææ¡ä»¶ã‚¨ãƒ©ãƒ¼ï¼ˆè¨˜äº‹æ•°ä¸è¶³ãªã©ï¼‰
            generateError = ex.Message;
            // è¨ºæ–­æƒ…å ±ã‚’æ›´æ–°
            diagnostics = await SummaryService.GetDiagnosticsAsync(selectedKeywordId.Value);
        }
        catch (Exception ex)
        {
            // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ï¼ˆAPIæ¥ç¶šã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
            generateError = $"ç”Ÿæˆã‚¨ãƒ©ãƒ¼: {ex.Message}";
            // è¨ºæ–­æƒ…å ±ã‚’æ›´æ–°
            diagnostics = await SummaryService.GetDiagnosticsAsync(selectedKeywordId.Value);
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task RegenerateSummary()
    {
        // æ—¢å­˜ã‚µãƒãƒªãƒ¼ãŒã‚ã£ã¦ã‚‚å†ç”Ÿæˆï¼ˆæ–°ã—ã„è¦ç´„ã¨ã—ã¦è¿½åŠ ï¼‰
        await GenerateSummary();
        // ç”Ÿæˆå¾Œã€å±¥æ­´ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
        await UpdateHistoryNavigationState();
    }

    private async Task GoToPreviousSummary()
    {
        if (!selectedKeywordId.HasValue || currentSummary == null) return;

        isNavigating = true;
        StateHasChanged();

        try
        {
            var previousSummary = await SummaryService.GetPreviousSummaryAsync(
                selectedKeywordId.Value, currentSummary.GeneratedAt);

            if (previousSummary != null)
            {
                currentSummary = previousSummary;
                await UpdateHistoryNavigationState();
            }
        }
        finally
        {
            isNavigating = false;
            StateHasChanged();
        }
    }

    private async Task GoToNextSummary()
    {
        if (!selectedKeywordId.HasValue || currentSummary == null) return;

        isNavigating = true;
        StateHasChanged();

        try
        {
            var nextSummary = await SummaryService.GetNextSummaryAsync(
                selectedKeywordId.Value, currentSummary.GeneratedAt);

            if (nextSummary != null)
            {
                currentSummary = nextSummary;
                await UpdateHistoryNavigationState();
            }
        }
        finally
        {
            isNavigating = false;
            StateHasChanged();
        }
    }

    private static string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown)) return string.Empty;
        var html = Markdown.ToHtml(markdown, _markdownPipeline);
        html = html.Replace("<a href=", "<a target=\"_blank\" rel=\"noopener noreferrer\" href=");
        return html;
    }

    private static string? GetTooltipText(Article article)
    {
        // æ—¥æœ¬èªè¦ç´„ãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°null
        if (!string.IsNullOrEmpty(article.SummaryJa))
        {
            // é•·ã™ãã‚‹å ´åˆã¯åˆ‡ã‚Šè©°ã‚ã‚‹
            var text = article.SummaryJa;
            if (text.Length > 150)
            {
                text = text[..150] + "...";
            }
            return text;
        }
        return null;
    }
}
