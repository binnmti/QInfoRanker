@page "/weekly-summary"
@rendermode InteractiveServer
@using QInfoRanker.Core.Entities
@using Markdig
@inject IWeeklySummaryService SummaryService
@inject IKeywordService KeywordService

<PageTitle>Weekly Summary - QInfoRanker</PageTitle>

<style>
    .summary-content {
        line-height: 1.8;
        font-size: 1rem;
    }
    .summary-content h2 {
        font-size: 1.5rem;
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }
    .summary-content h3 {
        font-size: 1.25rem;
        margin-top: 1.25rem;
        margin-bottom: 0.75rem;
        color: #495057;
    }
    .summary-content ul, .summary-content ol {
        margin-bottom: 1rem;
    }
    .summary-content li {
        margin-bottom: 0.5rem;
    }
    .summary-content a {
        color: #0d6efd;
        text-decoration: none;
    }
    .summary-content a:hover {
        text-decoration: underline;
    }
    .summary-meta {
        font-size: 0.875rem;
        color: #6c757d;
    }
    .summary-card {
        transition: box-shadow 0.2s ease;
    }
    .summary-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .past-summary-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .past-summary-item:hover {
        background-color: #f8f9fa;
    }
</style>

<h1>Weekly Summary</h1>

<div class="row mb-4">
    <div class="col-md-4">
        <label class="form-label">Keyword</label>
        <select class="form-select" @onchange="OnKeywordChanged">
            <option value="">-- Select Keyword --</option>
            @foreach (var keyword in keywords)
            {
                <option value="@keyword.Id" selected="@(selectedKeywordId == keyword.Id)">@keyword.Term</option>
            }
        </select>
    </div>
</div>

@if (isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (selectedKeywordId == null)
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Select a keyword to view the weekly summary.
    </div>
}
else if (currentSummary == null)
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        No weekly summary is available for this keyword yet.
        <br><small class="text-muted">Summaries are automatically generated when article collection completes.</small>

        <div class="mt-3">
            <button class="btn btn-primary" @onclick="GenerateSummary" disabled="@isGenerating">
                @if (isGenerating)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    <span>Generating...</span>
                }
                else
                {
                    <i class="bi bi-magic me-2"></i>
                    <span>Generate Summary Now (Debug)</span>
                }
            </button>
        </div>

        @if (!string.IsNullOrEmpty(generateError))
        {
            <div class="alert alert-danger mt-3 mb-0">
                <i class="bi bi-exclamation-circle me-2"></i>
                @generateError
            </div>
        }
    </div>
}
else
{
    <div class="card summary-card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">@currentSummary.Title</h4>
                <span class="badge bg-light text-dark">
                    @currentSummary.WeekStart.ToString("M/d") - @currentSummary.WeekEnd.ToString("M/d")
                </span>
            </div>
        </div>
        <div class="card-body">
            <div class="summary-meta mb-3">
                <span class="me-3">
                    <i class="bi bi-file-text me-1"></i>
                    @currentSummary.ArticleCount articles referenced
                </span>
                <span>
                    <i class="bi bi-clock me-1"></i>
                    Generated: @currentSummary.GeneratedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm")
                </span>
            </div>
            <hr />
            <div class="summary-content">
                @((MarkupString)RenderMarkdown(currentSummary.Content))
            </div>
        </div>
    </div>
}

@* Debug Tools Section *@
@if (selectedKeywordId != null)
{
    <div class="card border-warning mt-4">
        <div class="card-header bg-warning text-dark">
            <i class="bi bi-tools me-2"></i>Debug Tools
        </div>
        <div class="card-body">
            <div class="d-flex align-items-center gap-3 flex-wrap">
                <span class="text-muted">
                    <i class="bi bi-journal-text me-1"></i>
                    Summaries: <strong>@summaryCount</strong>
                </span>
                <button class="btn btn-outline-danger btn-sm" @onclick="DeleteSummaries" disabled="@isDeleting">
                    @if (isDeleting)
                    {
                        <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                        <span>Deleting...</span>
                    }
                    else
                    {
                        <i class="bi bi-trash me-1"></i>
                        <span>Delete All Summaries (Debug)</span>
                    }
                </button>
            </div>
            @if (!string.IsNullOrEmpty(deleteMessage))
            {
                <div class="alert @(deleteMessage.Contains("エラー") ? "alert-danger" : "alert-success") mt-3 mb-0">
                    @deleteMessage
                </div>
            }
        </div>
    </div>
}

@if (pastSummaries.Any())
{
    <h3 class="mt-5 mb-3">Past Summaries</h3>
    <div class="list-group">
        @foreach (var summary in pastSummaries)
        {
            <div class="list-group-item past-summary-item d-flex justify-content-between align-items-center"
                 @onclick="() => SelectSummary(summary)">
                <div>
                    <h6 class="mb-1">@summary.Title</h6>
                    <small class="text-muted">
                        @summary.WeekStart.ToString("M/d") - @summary.WeekEnd.ToString("M/d")
                        (@summary.ArticleCount articles)
                    </small>
                </div>
                <span class="badge bg-secondary">@summary.Keyword?.Term</span>
            </div>
        }
    </div>
}

@code {
    private List<Keyword> keywords = new();
    private int? selectedKeywordId;
    private Core.Entities.WeeklySummary? currentSummary;
    private List<Core.Entities.WeeklySummary> pastSummaries = new();
    private bool isLoading = false;
    private bool isGenerating = false;
    private string? generateError;
    private bool isDeleting = false;
    private string? deleteMessage;
    private int summaryCount = 0;

    private static readonly MarkdownPipeline _markdownPipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .UseAutoLinks()
        .Build();

    protected override async Task OnInitializedAsync()
    {
        keywords = (await KeywordService.GetActiveAsync()).ToList();
        pastSummaries = (await SummaryService.GetSummariesAsync(null, 20)).ToList();
    }

    private async Task OnKeywordChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var keywordId))
        {
            selectedKeywordId = keywordId;
            await LoadSummary();
        }
        else
        {
            selectedKeywordId = null;
            currentSummary = null;
        }
    }

    private async Task LoadSummary()
    {
        if (selectedKeywordId == null) return;

        isLoading = true;
        deleteMessage = null;
        StateHasChanged();

        try
        {
            currentSummary = await SummaryService.GetCurrentWeekSummaryAsync(selectedKeywordId.Value);
            pastSummaries = (await SummaryService.GetSummariesAsync(selectedKeywordId.Value, 10)).ToList();
            summaryCount = pastSummaries.Count;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void SelectSummary(Core.Entities.WeeklySummary summary)
    {
        currentSummary = summary;
        selectedKeywordId = summary.KeywordId;
    }

    private async Task GenerateSummary()
    {
        if (selectedKeywordId == null) return;

        isGenerating = true;
        generateError = null;
        StateHasChanged();

        try
        {
            var summary = await SummaryService.GenerateSummaryAsync(selectedKeywordId.Value);
            if (summary != null)
            {
                currentSummary = summary;
                pastSummaries = (await SummaryService.GetSummariesAsync(selectedKeywordId.Value, 10)).ToList();
            }
            else
            {
                generateError = "サマリーの生成に失敗しました。対象となる記事が見つからない可能性があります。";
            }
        }
        catch (Exception ex)
        {
            generateError = $"エラーが発生しました: {ex.Message}";
        }
        finally
        {
            isGenerating = false;
            StateHasChanged();
        }
    }

    private async Task DeleteSummaries()
    {
        if (selectedKeywordId == null) return;

        isDeleting = true;
        deleteMessage = null;
        StateHasChanged();

        try
        {
            var deletedCount = await SummaryService.DeleteByKeywordAsync(selectedKeywordId.Value);
            currentSummary = null;
            pastSummaries.Clear();
            summaryCount = 0;
            deleteMessage = $"{deletedCount}件のサマリーを削除しました。";
        }
        catch (Exception ex)
        {
            deleteMessage = $"エラーが発生しました: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
            StateHasChanged();
        }
    }

    private static string RenderMarkdown(string markdown)
    {
        if (string.IsNullOrEmpty(markdown)) return string.Empty;
        var html = Markdown.ToHtml(markdown, _markdownPipeline);
        // 全てのリンクを新しいタブで開くように修正
        html = html.Replace("<a href=", "<a target=\"_blank\" rel=\"noopener noreferrer\" href=");
        return html;
    }
}
